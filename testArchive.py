from pathlib import Path
import concurrent.futures
import gzip
import os
import time

# Initialize shared variables
errorList = []

def process_file(file_path, chunk_size=1024 * 1024, max_retries=3):
    retries = 0
    while retries < max_retries:
        try:
            with gzip.open(file_path, mode='rt', encoding="utf-8", errors="ignore") as f:
                while True:
                    tempString = f.read(chunk_size)
                    if not tempString:
                        break
                    # Process the chunk here
            return None  # No error occurred, so return None
        except MemoryError as e:
            retries += 1
            wait_time = retries * 5  # Exponential backoff: 5s, 10s, 15s
            print(f"MemoryError processing {file_path}. Retrying {retries}/{max_retries} after {wait_time} seconds...")
            time.sleep(wait_time)  # Wait before retrying
        except Exception as e:
            return (file_path, e)  # Log other errors immediately
    return (file_path, "MemoryError after max retries")  # Log failure after max retries

def main():
    count = 0
    #pcode_dir = Path("/mnt/g/pcodeCompressed")
    max_threads = 4  # Adjust based on your system's capability
    badConversions = [(Path('/mnt/g/pcodeCompressed/198PdXRpGVZAzYxCrF0e.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/2GPmRJEgDjHqoT7YN9M5.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/3MbT7ePSqZuEWgXpiKDm.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/3oA2emBxRQTkvDrVqPfL.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/5aVfOX3lym7ZECUehLD8.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/5i3dyOv9GDKJuCVHF0q1.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/6c4doT8bL0DuwP9pGtOv.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/7iEfJHXeGdvRDhx364nL.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/7NhfmldVgt912wn8MYDs.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/9DnIFm7V0UklpyfzAog4.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/9f5wo2qZsPe3YWAvyJjt.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/ATfrBeFJV9U2NDdCmEcZ.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/BxhpgtQbsyuqY06HJ2OT.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/CL7wiUdlhOvgaJesfrmW.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/cVFaWK1b2dBXCho37sjE.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/daYJhP9jKDTN5o8Z1b2G.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/dexOVwSPEDv4AYR8f3bI.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/dFjMQn7q1K8Z6ziwG0TP.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/DnJFtCH7gTMIvWYlAxcN.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/fcId81lTeFim0jMzXo6R.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/fl4qpgSOjG8109BvVMEH.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/fnXmaJVsYryHwPtgD5L6.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/GKL3rD2YSf9xiXIPzeb6.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/gm6EuQ9WT1AbsPJOSnKc.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/gq1T5uf3MyIdtU0HsN9a.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/hU9dnkVNuPCJbLysXlzp.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/i0gZtoAOmxsID4cKHaul.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/J1LCS4Foa2jbAOYGWQhz.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/jlSnNDwm6Arby4cQv0ox.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/JlYNWgvo2LCkQRV8d74u.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached')), (Path('/mnt/g/pcodeCompressed/k8qrhNTAG54fSl6jDtVa.pcode'), EOFError('Compressed file ended before the end-of-stream marker was reached'))]
    with concurrent.futures.ThreadPoolExecutor(max_workers=max_threads) as executor:
        futures = {executor.submit(process_file, each[0]): each for each in badConversions} #pcode_dir.iterdir()}

        for future in concurrent.futures.as_completed(futures):
            count += 1
            print(count)
            result = future.result()
            if result is not None:  # If there was an error
                errorList.append(result)

    print(len(errorList))
    print(errorList)

if __name__ == "__main__":
    main()